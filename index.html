<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>AI Non-OASIS Analyzer (Unified)</title>
        <style>
    /* --- GLOBAL LAYOUT (Dark Theme) --- */
    body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #0b1f2a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #ffffff;
    }

    .card {
        width: 650px; /* Slightly wider to accommodate more data */
        background: #081821;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 20px 50px rgba(0,0,0,.45);
        margin: 20px 0;
        position: relative;
        border: 1px solid #1f3a4d;
    }

    /* --- UPLOAD CARD STYLES --- */
    .upload-card {
        background: linear-gradient(180deg, #0c2230, #081821);
        border: 1px solid #1f3a4d;
        border-radius: 14px;
        padding: 22px;
    }

    .upload-header {
        display: flex;
        gap: 12px;
        margin-bottom: 18px;
    }

    .upload-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: rgba(79,163,255,0.15);
        color: #7abaff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
    }

    .upload-title {
        font-size: 15px;
        font-weight: 600;
        color: #e4f1ff;
    }

    .upload-subtitle {
        font-size: 12px;
        color: #9bb9d4;
    }

    /* --- UPLOAD ZONE --- */
    .upload-zone {
        border: 2px dashed #355a74;
        border-radius: 12px;
        padding: 26px;
        text-align: center;
        background: #06141c;
        cursor: pointer;
        transition: all 0.25s ease;
        margin-bottom: 16px;
    }

    .upload-zone:hover {
        border-color: #7abaff;
        background: #081d2a;
    }

    .upload-zone-icon {
        font-size: 30px;
        color: #7abaff;
        margin-bottom: 6px;
    }

    .upload-zone-text {
        font-size: 13px;
        font-weight: 600;
        color: #d6eaff;
    }

    /* --- FILE LIST --- */
    .file-section-header {
        font-size: 13px;
        font-weight: 600;
        color: #cfe7ff;
        margin-bottom: 10px;
        display: none;
    }

    .file-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 16px;
    }

    .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #ffffff;
        border-radius: 12px;
        padding: 10px 14px;
        border: 1px solid #e6e6e6;
        transition: all 0.2s ease;
    }

    .file-left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
    }

    .file-type-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: #eef5ff;
        color: #4fa3ff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .file-meta {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .file-name {
        font-size: 13px;
        font-weight: 600;
        color: #1e1e1e;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 260px;
    }

    .file-size {
        font-size: 11px;
        color: #6b6b6b;
    }

    .remove-btn {
        background: transparent;
        border: none;
        color: #9b9b9b;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .remove-btn:hover {
        background: #ffecec;
        color: #d64545;
    }

    /* --- BUTTONS --- */
    .analyze-btn {
        width: 100%;
        padding: 13px;
        border-radius: 10px;
        background: linear-gradient(135deg, #4fa3ff, #7abaff);
        border: none;
        font-size: 14px;
        font-weight: 600;
        color: #04121a;
        cursor: pointer;
        transition: all 0.25s ease;
    }

    .analyze-btn:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 30px rgba(79,163,255,0.35);
    }

    .analyze-btn:disabled {
        background: #6b6b6b;
        color: #d1d1d1;
        cursor: not-allowed;
    }

    .save-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #4cff9f, #27ae60);
        color: #052e16;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        margin-top: 15px;
        cursor: pointer;
    }

    .save-btn:disabled {
        background: #7f8c8d;
        color: #fff;
        cursor: not-allowed;
    }

    /* --- PROGRESS --- */
    .progress-wrapper {
        display: none;
        margin-top: 18px;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #9bb9d4;
        margin-bottom: 6px;
    }

    .progress-container {
        background: #102a3a;
        border-radius: 10px;
        height: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4fa3ff, #7abaff);
        transition: width 0.4s ease;
    }

    .status {
        margin-top: 15px;
        font-size: 13px;
        text-align: center;
        min-height: 20px;
    }
    .success { color: #4cff9f; }
    .error { color: #ff7a7a; }

    /* --- RESULTS --- */
    #resultArea {
        display: none;
        margin-top: 25px;
        border-top: 1px solid #1f3a4d;
        padding-top: 20px;
    }
    
    .result-box {
        width: 100%;
        background: #050e13;
        color: #a6e22e;
        border: 1px solid #1f3a4d;
        border-radius: 6px;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
        resize: vertical;
        box-sizing: border-box;
        margin-bottom: 15px;
    }

    textarea#jsonOutput { height: 180px; }
    textarea#f2fOutput { height: 80px; color: #ffc107; } 
    textarea#ptotOutput { height: 150px; color: #64d2ff; } /* Blue tint for Therapy */

    label {
        font-size: 12px;
        color: #8daac2;
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .upload-disabled {
        pointer-events: none;
        opacity: 0.45;
    }
    .upload-disabled * {
        cursor: wait !important;
    }
        </style>
    </head>
    <body>
        <div class="card">
            <h2 style="margin-top:0; margin-bottom:8px; font-weight:600; text-align:center; color:#e0e0e0;">AI Unified Clinical Analyzer</h2>
            <p style="font-size:14px; opacity:0.7; text-align:center; margin-bottom:25px; color:#8daac2;">Diagnosis, F2F Summary & Therapy Assessments</p>
            
            <div id="loadingMessage" style="text-align:center; color:#4fa3ff; margin-bottom:15px; font-weight:500;">
                Connecting to Salesforce...
            </div>
            
            <div id="mainControls" class="upload-card" style="display:none;">
                <div class="upload-header">
                    <div class="upload-icon">üìÑ</div>
                    <div>
                        <div class="upload-title">Upload Clinical Documents</div>
                        <div class="upload-subtitle">
                            PT/OT Evals, Face-to-Face, Encounter Notes
                        </div>
                    </div>
                </div>
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <input
                        type="file"
                        id="fileInput"
                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                        multiple
                        hidden
                        onchange="handleFileSelect(this)"
                    >
                    <div class="upload-zone-icon">‚¨ÜÔ∏è</div>
                    <div class="upload-zone-text">Click to upload or drag files here</div>
                </div>
                <div id="fileSectionHeader" class="file-section-header">
                    Uploaded Files (
                    <span id="fileCount">0</span>
                    )
                </div>
                <div id="fileListContainer" class="file-list"></div>
                <button id="analyzeBtn" class="analyze-btn" onclick="startAnalysis()">
                    Analyze Documents
                </button>
            </div>

            <div id="progressWrapper" class="progress-wrapper">
                <div class="progress-label">
                    <span id="progressText">Analyzing...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-container">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div id="status" class="status"></div>

            <div id="resultArea">
                <label>F2F Encounter Summary:</label>
                <textarea id="f2fOutput" class="result-box" readonly placeholder="F2F Summary will appear here..."></textarea>
                
                <label>Therapy (PT/OT) Functional Assessment:</label>
                <textarea id="ptotOutput" class="result-box" readonly placeholder="PT/OT Functional scores will appear here..."></textarea>

                <label>Final Audited Result (ICD-10 Compliant):</label>
                <textarea id="jsonOutput" class="result-box" readonly placeholder="ICD-10 Audit will appear here..."></textarea>
                
                <button id="saveBtn" class="save-btn" onclick="finalizeSave()">
                    Save All Data & Files
                </button>
            </div>
        </div>

        <script>

            function disableUploadUI() {
                document.getElementById("mainControls").classList.add("upload-disabled");
            }

            function enableUploadUI() {
                document.getElementById("mainControls").classList.remove("upload-disabled");
            }

/* =========================================================
   GLOBAL CONTEXT
   ========================================================= */

let CHART_ID = null;
let GEMINI_API_KEY = null;
let SF_SESSION_ID = null;
let SF_BASE_URL = null; 
let VECTOR_STORE_ID = null;
let CACHED_AI_TIME = 0;

// Array to store actual File objects
let selectedFiles = [];

const GEMINI_VISION_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent"; 
const GEMINI_RAG_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent"; 

/* =========================================================
   SALESFORCE CONNECTION
   ========================================================= */

window.addEventListener("message", (event) => {
    if (event.data && event.data.type === "SF_CONTEXT") {
        console.log("‚úÖ Received Context from Salesforce");
        
        CHART_ID = event.data.recordId;
        GEMINI_API_KEY = event.data.apiKey;
        SF_SESSION_ID = event.data.sessionId;
        SF_BASE_URL = event.data.baseUrl;
        VECTOR_STORE_ID = event.data.vectorStoreId;
        
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("mainControls").style.display = "block";
    }
});

/* =========================================================
   FILE UI LOGIC
   ========================================================= */

function handleFileSelect(inputElement) {
    if (inputElement.files && inputElement.files.length > 0) {
        for (let i = 0; i < inputElement.files.length; i++) {
            selectedFiles.push(inputElement.files[i]);
        }
        renderFileList();
        inputElement.value = ""; 
    }
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderFileList();
}

function renderFileList() {
    const container = document.getElementById("fileListContainer");
    const header = document.getElementById("fileSectionHeader");
    const countSpan = document.getElementById("fileCount");

    container.innerHTML = "";

    if (selectedFiles.length === 0) {
        container.style.display = "none";
        header.style.display = "none";
        return;
    }

    header.style.display = "block";
    container.style.display = "flex";
    countSpan.innerText = selectedFiles.length;

    selectedFiles.forEach((file, index) => {
        const item = document.createElement("div");
        item.className = "file-item";
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        item.innerHTML = `
            <div class="file-left">
                <div class="file-type-icon">üìÑ</div>
                <div class="file-meta">
                    <div class="file-name" title="${file.name}">${file.name}</div>
                    <div class="file-size">${sizeMB} MB</div>
                </div>
            </div>
            <button class="remove-btn" onclick="removeFile(${index})" title="Remove">‚úñ</button>
        `;
        container.appendChild(item);
    });
}

/* =========================================================
   PROGRESS BAR HELPER
   ========================================================= */

function updateProgress(percent, text) {
    const wrapper = document.getElementById("progressWrapper");
    const fill = document.getElementById("progressFill");
    const textSpan = document.getElementById("progressText");
    const percentSpan = document.getElementById("progressPercent");

    wrapper.style.display = "block";
    fill.style.width = percent + "%";
    if (text) textSpan.innerText = text;
    percentSpan.innerText = percent + "%";
}

let progressTimer = null;
let progressValue = 1;

function startAutoProgress(target = 90, speed = 120) {
    clearInterval(progressTimer);
    progressTimer = setInterval(() => {
        if (progressValue < target) {
            progressValue++;
            updateProgress(progressValue);
        } else {
            clearInterval(progressTimer);
        }
    }, speed);
}

function stopAutoProgress(finalValue = 100, text = "Complete") {
    clearInterval(progressTimer);
    progressValue = finalValue;
    updateProgress(progressValue, text);
}

/* =========================================================
   MAIN ANALYSIS LOGIC
   ========================================================= */

async function startAnalysis() {
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultArea = document.getElementById("resultArea");
    const jsonOutput = document.getElementById("jsonOutput");
    const f2fOutput = document.getElementById("f2fOutput");
    const ptotOutput = document.getElementById("ptotOutput");
    
    // UI Reset
    resultArea.style.display = "none";
    jsonOutput.value = "";
    f2fOutput.value = "";
    ptotOutput.value = "";
    showStatus(""); 
    
    // Validations
    if (!CHART_ID || !GEMINI_API_KEY) {
        showStatus("‚ùå Configuration missing. Refresh Salesforce page.", true);
        return;
    }

    if (selectedFiles.length === 0) {
        showStatus("‚ùå Please upload at least one file.", true);
        return;
    }
    try {
        analyzeBtn.disabled = true;
        disableUploadUI();
        analyzeBtn.innerText = "Analyzing...";

        progressValue = 1;
        updateProgress(1, "Initializing Batch...");
        startAutoProgress(90, 120);

        const startTime = Date.now();

        // --- STEP 1: READ FILES ---
        updateProgress(progressValue, `Reading ${selectedFiles.length} file(s)...`);
        const fileDataArray = await Promise.all(
            selectedFiles.map(file => readFileAsBase64(file))
        );

        // --- STEP 2: PARALLEL AI EXECUTION (Diagnoses, F2F, PT/OT) ---
        updateProgress(progressValue, "Scanning for Diagnoses, F2F, and Therapy Data...");
        
        const [rawExtraction, f2fSummaryText, ptotJsonText] = await Promise.all([
            callGeminiVisionMulti(fileDataArray),    // Diagnosis Extraction
            callGeminiF2FSummary(fileDataArray),     // F2F Summary
            callGeminiPtOtExtraction(fileDataArray)  // NEW: PT/OT Extraction
        ]);

        // --- STEP 3: AUDIT DIAGNOSES ---
        updateProgress(progressValue, "AI Auditor: Validating ICD-10 Rules...");
        const finalAuditJson = await callGeminiAuditor(rawExtraction);

        CACHED_AI_TIME = Math.floor((Date.now() - startTime) / 1000);

        // --- STEP 4: DISPLAY RESULTS ---
        
        // Format Diagnosis JSON
        let prettyJson = finalAuditJson;
        try {
            const cleanJson = finalAuditJson.replace(/```json/g, "").replace(/```/g, "").trim();
            prettyJson = JSON.stringify(JSON.parse(cleanJson), null, 4);
        } catch {}

        // Format PT/OT JSON
        let prettyPtOt = ptotJsonText;
        try {
            const cleanPtOt = ptotJsonText.replace(/```json/g, "").replace(/```/g, "").trim();
            prettyPtOt = JSON.stringify(JSON.parse(cleanPtOt), null, 4);
        } catch {}

        jsonOutput.value = prettyJson;
        f2fOutput.value = f2fSummaryText;
        ptotOutput.value = prettyPtOt; // Display PT/OT result
        
        resultArea.style.display = "block";

        stopAutoProgress(100, "Complete");

        setTimeout(() => {
            document.getElementById("mainControls").style.display = "none";
        }, 500);

        showStatus("‚úÖ Analysis Complete.", false);

    } catch (error) {
        console.error(error);
        stopAutoProgress(progressValue, "Failed");
        showStatus("‚ùå " + error.message, true);

    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerText = "Analyze Files";
        enableUploadUI();
    }
}

/* =========================================================
   SAVE LOGIC (Unified)
   ========================================================= */

async function finalizeSave() {
    const saveBtn = document.getElementById("saveBtn");
    const jsonOutput = document.getElementById("jsonOutput");
    const f2fOutput = document.getElementById("f2fOutput");
    const ptotOutput = document.getElementById("ptotOutput");
    
    try {
        saveBtn.disabled = true;
        
        // --- PART 1: SAVE DATA VIA APEX ---
        saveBtn.innerText = "Saving Data...";
        // We pass ALL data (Diagnoses, F2F, and PT/OT)
        await sendToSalesforce(jsonOutput.value, f2fOutput.value, ptotOutput.value, CACHED_AI_TIME);

        // --- PART 2: UPLOAD FILES ---
        if (selectedFiles.length > 0) {
            saveBtn.innerText = `Uploading ${selectedFiles.length} Files...`;
            await saveFilesToSalesforceRecord();
        }
        
        showStatus("‚úÖ Data & Files Saved Successfully!", false);
        saveBtn.innerText = "Saved";
        setTimeout(() => {
            window.location.href = `${SF_BASE_URL}/lightning/r/Chart__c/${CHART_ID}/view`;
        }, 800);
        
        setTimeout(() => { 
            saveBtn.disabled = true; 
            saveBtn.innerText = "Save All Data & Files"; 
        }, 3000);

    } catch (e) {
        console.error(e);
        showStatus("‚ùå Save failed: " + e.message, true);
        saveBtn.disabled = false;
        saveBtn.innerText = "Save All Data & Files";
    }
}

// Updated to include ptOtData
async function sendToSalesforce(rawJson, f2fSummary, ptOtData, aiTimeSeconds) {
    const endpoint =  `${SF_BASE_URL}/services/apexrest/non-oasis/ai-result`;
    const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Authorization": "Bearer " + SF_SESSION_ID, "Content-Type": "application/json" },
        body: JSON.stringify({ 
            chartId: CHART_ID, 
            rawJson: rawJson, 
            f2fSummary: f2fSummary,
            ptOtJson: ptOtData, // Added new field for PT/OT
            aiTimeSeconds: aiTimeSeconds 
        })
    });
    if (!response.ok) throw new Error(await response.text());
}

async function saveFilesToSalesforceRecord() {
    const endpoint = `${SF_BASE_URL}/services/data/v57.0/sobjects/ContentVersion`;
    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        try {
            const fileData = await readFileAsBase64(file); 
            const payload = {
                "Title": file.name,
                "PathOnClient": file.name,
                "VersionData": fileData.base64, 
                "FirstPublishLocationId": CHART_ID, 
                "Origin": "H" 
            };
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { 
                    "Authorization": "Bearer " + SF_SESSION_ID, 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json(); 
                throw new Error(errorData[0]?.message || "Unknown error");
            }
        } catch (err) {
            console.error(err);
            showStatus(`‚ùå Failed to upload ${file.name}: ${err.message}`, true);
        }
    }
}

/* =========================================================
   API CALLS (GEMINI)
   ========================================================= */

// --- 1. F2F SUMMARY ---
async function callGeminiF2FSummary(fileDataArray) {
    const f2fPrompt = `
You will receive uploaded clinical documents.
Determine whether ANY file represents a clinical Face-to-Face (F2F) visit note, Encounter note, or Evaluation.
If no such document exists, reply EXACTLY: "No F2F document found."

If such a document EXISTS:
‚Üí Provide a concise clinical summary UNDER 200 WORDS including:
   - Reason for visit
   - Key diagnoses
   - Symptoms/findings
   - Plan/Follow-up

Summarize ONLY what is written.
    `;
    const parts = [{ text: f2fPrompt }];
    fileDataArray.forEach(f => {
        parts.push({ inlineData: { mimeType: f.mimeType, data: f.base64 } });
    });
    const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: parts }] })
    });
    if (!response.ok) return "No F2F document found.";
    const data = await response.json();
    return data.candidates[0].content.parts[0].text.replace(/\*/g, "").trim();
}

// --- 2. PT/OT EXTRACTION (NEW) ---
async function callGeminiPtOtExtraction(fileDataArray) {
    const ptOtPrompt = `
Role: Medical Data Encoder.
Task: Extract functional assessment data from PT or OT documents.

Value Mapping Rules (Strict):
Convert text terms to numeric codes:
- "Independent", "Safe", "Ind", "6" -> "6"
- "Setup", "Cleanup", "Mod I", "5" -> "5"
- "Supervision", "SBA", "Stand By Assist", "Touch", "CGA", "Min A", "Mod A", "Contact Guard" -> "4"
- "Max Assist", "Total Assist", "Dependent", "Unable", "1", "2" -> "2"
- "Not Attempted", "N/A" -> "NT"

JSON Output Keys (Return ONLY valid JSON):
{
  "Discipline": "PT or OT or N/A",
  "Eval_Date": "YYYY-MM-DD",
  "Bed_Mobility": "Code (6,5,4,2,NT)",
  "Transfers": "Code",
  "Ambulation": "Code",
  "Bathing": "Code",
  "Dressing_Upper": "Code",
  "Dressing_Lower": "Code",
  "Toileting": "Code",
  "Feeding": "Code"
}
If no PT/OT document is present, return empty JSON "{}".
    `;

    const parts = [{ text: ptOtPrompt }];
    fileDataArray.forEach(f => {
        parts.push({ inlineData: { mimeType: f.mimeType, data: f.base64 } });
    });

    const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: parts }] })
    });

    if (!response.ok) return "{}";
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

// --- 3. DIAGNOSIS EXTRACTION ---
async function callGeminiVisionMulti(fileDataArray) {
    const extractionPrompt = `
You are a clinical document extraction auditor.
Extract diagnoses EXACTLY as written.

STRICT OUTPUT FORMAT:
SECTION 1: PATIENT DIAGNOSIS DETAILS
Patient Name: <name>
Age: <age>

Potential Primary Diagnoses:
- Diagnosis: <dx>
  ICD Code: <code>
  Reason & Source: <text>

Secondary Diagnoses:
- Diagnosis: <dx>
  ICD Code: <code>
  Reason & Source: <text>
    `;
    const parts = [{ text: extractionPrompt }];
    fileDataArray.forEach(f => {
        parts.push({ inlineData: { mimeType: f.mimeType, data: f.base64 } });
    });
    const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: parts }] })
    });
    if (!response.ok) throw new Error("Vision Step Failed");
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

// --- 4. AUDITOR ---
async function callGeminiAuditor(extractedText) {
    const auditorSystemPrompt = `
You are an ICD-10-CM Auditor.
Validate the input diagnoses against official ICD-10 rules (Excludes1, Sequencing, Code First).
Output strictly formatted JSON:
[
  { "code": "ICD", "reasonSource": "Text", "potentialPrimary": true/false }
]
    `;
    const userPrompt = `INPUT:\n${extractedText}`;
    let toolsConfig = [];
    if (VECTOR_STORE_ID) {
        toolsConfig = [{ retrieval: { vertex_ai_search: { datastore: VECTOR_STORE_ID } } }];
    }
    const response = await fetch(`${GEMINI_RAG_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            system_instruction: { parts: [{ text: auditorSystemPrompt }] },
            contents: [{ parts: [{ text: userPrompt }] }],
            tools: toolsConfig
        })
    });
    if (!response.ok) throw new Error("Audit Step Failed");
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

/* =========================================================
   HELPERS
   ========================================================= */

function showStatus(message, isError = false) {
    const status = document.getElementById("status");
    status.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
}

function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
            mimeType: file.type,
            base64: reader.result.split(",")[1],
            name: file.name
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}
        </script>
    </body>
</html>

