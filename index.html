<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI OASIS Analyzer & ICD-10 Auditor</title>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #0b1f2a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #ffffff;
    }

    .card {
        width: 520px;
        background: #081821;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 20px 50px rgba(0,0,0,.45);
        margin: 20px 0;
        position: relative; /* For absolute positioning if needed */
        border: 1px solid #1f3a4d; /* Subtle border for tech feel */
    }

    h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-weight: 600;
        text-align: center;
        letter-spacing: 0.5px;
        color: #e0e0e0;
    }

    p {
        font-size: 14px;
        opacity: 0.7;
        text-align: center;
        margin-bottom: 25px;
        color: #8daac2;
    }

    input[type="file"] {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px dashed #4fa3ff;
        background: #06141c;
        color: #fff;
        cursor: pointer;
        box-sizing: border-box;
        margin-bottom: 15px;
        transition: border-color 0.3s;
    }
    
    input[type="file"]:hover {
        border-color: #7abaff;
        background: #091e2b;
    }

    button {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #4fa3ff, #2980b9);
        border: none;
        border-radius: 8px;
        color: #fff;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 15px rgba(79, 163, 255, 0.3);
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 163, 255, 0.4);
    }

    button:disabled {
        background: #374752;
        color: #7c8c99;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Green Save Button style */
    .save-btn {
        background: linear-gradient(135deg, #4cff9f, #27ae60);
        color: #052e16;
        margin-top: 15px;
        box-shadow: 0 4px 15px rgba(76, 255, 159, 0.3);
    }
    .save-btn:hover {
        background: linear-gradient(135deg, #7dfcbd, #2ecc71);
        box-shadow: 0 6px 20px rgba(76, 255, 159, 0.4);
    }

    .status {
        margin-top: 10px;
        font-size: 13px;
        min-height: 20px;
        text-align: center;
        line-height: 1.5;
        font-weight: 500;
    }

    .success { color: #4cff9f; }
    .error { color: #ff7a7a; }
    
    /* --- ADVANCED PROGRESS BAR --- */
    #progressWrapper {
        display: none; /* Hidden by default */
        margin-top: 20px;
        width: 100%;
    }

    .progress-container {
        width: 100%;
        height: 8px;
        background-color: #0f2735;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4fa3ff, #00d2ff);
        border-radius: 4px;
        transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        position: relative;
        box-shadow: 0 0 10px rgba(79, 163, 255, 0.5);
    }

    /* Animated sheen effect on the bar */
    .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.3) 50%,
            rgba(255, 255, 255, 0) 100%
        );
        transform: translateX(-100%);
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        100% { transform: translateX(100%); }
    }

    .progress-label {
        font-size: 12px;
        color: #4fa3ff;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }

    /* --- JSON PREVIEW --- */
    #resultArea {
        display: none;
        margin-top: 25px;
        border-top: 1px solid #1f3a4d;
        padding-top: 20px;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    textarea {
        width: 100%;
        height: 250px;
        background: #050e13;
        color: #a6e22e;
        border: 1px solid #1f3a4d;
        border-radius: 8px;
        padding: 12px;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 12px;
        resize: vertical;
        box-sizing: border-box;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
    }

    textarea:focus {
        outline: none;
        border-color: #4fa3ff;
    }

    label {
        font-size: 12px;
        color: #8daac2;
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
</head>

<body>

<div class="card">
    <h2>AI Non - OASIS Analyzer</h2>
    <p>Extraction & ICD-10 Compliance Audit</p>

    <div id="loadingMessage" style="text-align:center; color:#4fa3ff; margin-bottom:15px; font-weight:500;">
        Connecting to Salesforce...
    </div>

    <div id="mainControls" style="display:none;">
        <label>Select Document (Chart):</label>
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />

        <button id="analyzeBtn" onclick="startAnalysis()">
            Run Analysis & Audit
        </button>

        <div id="progressWrapper">
            <div class="progress-label">
                <span id="progressText">Initializing...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-container">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <div id="status" class="status"></div>

    <div id="resultArea">
        <label>Final Audited Result (ICD-10 Compliant):</label>
        <textarea id="jsonOutput" readonly></textarea>
        
        <button id="saveBtn" class="save-btn" onclick="finalizeSave()">
            Save to Salesforce
        </button>
    </div>
</div>

<script>
/* =========================================================
   GLOBAL CONTEXT
   ========================================================= */

let CHART_ID = null;
let GEMINI_API_KEY = null;
let SF_SESSION_ID = null;
let SF_BASE_URL = null; 
let VECTOR_STORE_ID = null; // Passed from Salesforce for RAG
let CACHED_AI_TIME = 0;

// Step 1 Model: Vision/Fast
const GEMINI_VISION_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent"; 

// Step 2 Model: Reasoning/RAG (Pro is better for Audit logic)
const GEMINI_RAG_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent"; 

/* =========================================================
   LISTENER: RECEIVE DATA FROM SALESFORCE LWC
   ========================================================= */

const ALLOWED_ORIGINS = [
    "https://codingdepartment--pcopy.sandbox.lightning.force.com",
    "https://codingdepartment--pcopy.sandbox.my.salesforce.com"
];

window.addEventListener("message", (event) => {
    // Optional: Security check on event.origin if required
    
    if (event.data && event.data.type === "SF_CONTEXT") {
        console.log("✅ Received Context from Salesforce");
        
        CHART_ID = event.data.recordId;
        GEMINI_API_KEY = event.data.apiKey;
        SF_SESSION_ID = event.data.sessionId;
        SF_BASE_URL = event.data.baseUrl;
        VECTOR_STORE_ID = event.data.vectorStoreId; // Capture the RAG Store ID
        
        // Update UI
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("mainControls").style.display = "block";
        
        showStatus("✅ Connected. Ready to analyze.", false);
    }
});

/* =========================================================
   UI HELPERS (PROGRESS BAR)
   ========================================================= */

function updateProgress(percent, text) {
    const wrapper = document.getElementById("progressWrapper");
    const fill = document.getElementById("progressFill");
    const textSpan = document.getElementById("progressText");
    const percentSpan = document.getElementById("progressPercent");

    // Show wrapper if hidden
    wrapper.style.display = "block";

    // Update width and text
    fill.style.width = percent + "%";
    if (text) textSpan.innerText = text;
    percentSpan.innerText = percent + "%";
}

function resetProgress() {
    document.getElementById("progressWrapper").style.display = "none";
    document.getElementById("progressFill").style.width = "0%";
}

/* =========================================================
   MAIN LOGIC (CHAINED PROMPTS)
   ========================================================= */

async function startAnalysis() {
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultArea = document.getElementById("resultArea");
    const jsonOutput = document.getElementById("jsonOutput");
    const file = document.getElementById("fileInput").files[0];
    
    // Reset UI
    resultArea.style.display = "none";
    jsonOutput.value = "";
    showStatus(""); // Clear old status
    
    if (!CHART_ID || !GEMINI_API_KEY) {
        showStatus("❌ Configuration missing. Refresh Salesforce page.", true);
        return;
    }

    if (!file) {
        showStatus("❌ Please select a file", true);
        return;
    }

    try {
        analyzeBtn.disabled = true;
        updateProgress(5, "Initializing..."); // Start progress

        const startTime = Date.now();
        
        // --- STEP 1: READ FILE ---
        updateProgress(15, "Reading document...");
        const base64Data = await readFileAsBase64(file);

        // --- STEP 2: VISION EXTRACTION (First Prompt) ---
        // Simulating progress jump for UX
        updateProgress(30, "AI Vision: Extracting clinical data...");
        
        const rawExtraction = await callGeminiVision(file.type, base64Data);
        console.log("Step 1 Output:", rawExtraction);

        updateProgress(60, "Data Extracted. Starting Audit...");

        // --- STEP 3: RAG AUDIT (Second Prompt) ---
        updateProgress(75, "AI Auditor: Checking ICD-10 Rules...");
        
        // Pass the result of Step 1 into Step 2
        const finalAuditJson = await callGeminiAuditor(rawExtraction);
        
        updateProgress(95, "Finalizing results...");
        
        CACHED_AI_TIME = Math.floor((Date.now() - startTime) / 1000);

        // --- STEP 4: DISPLAY RESULT ---
        // Pretty print logic
        let prettyJson = finalAuditJson;
        try {
            // Clean markdown blocks if present
            const cleanJson = finalAuditJson.replace(/```json/g, "").replace(/```/g, "").trim();
            const parsed = JSON.parse(cleanJson);
            prettyJson = JSON.stringify(parsed, null, 4);
        } catch (e) {
            console.warn("Could not pretty print JSON");
        }

        jsonOutput.value = prettyJson;
        resultArea.style.display = "block";
        analyzeBtn.disabled = false;
        
        updateProgress(100, "Complete");
        setTimeout(() => {
             // Optional: Hide progress bar after completion or leave at 100%
             // resetProgress(); 
             showStatus("✅ Analysis & Audit Complete. Review below.", false);
        }, 800);

    } catch (error) {
        console.error(error);
        showStatus("❌ " + error.message, true);
        analyzeBtn.disabled = false;
        // Turn bar red on error?
        document.getElementById("progressFill").style.background = "#ff7a7a";
        document.getElementById("progressText").innerText = "Error";
    }
}

/* =========================================================
   API CALLS
   ========================================================= */

// --- CALL 1: EXTRACT DATA (VISION) ---
async function callGeminiVision(mimeType, base64Data) {
    
    const extractionPrompt = `
You are a clinical document extraction auditor.
You MUST perform a FULL scan of ALL uploaded files before generating output.

Your job:
- Extract diagnoses EXACTLY as written
- Identify potential primary diagnoses
- Provide justification for each selected diagnosis
- Specify the exact location (page, section, or line reference)

STRICT OUTPUT FORMAT (Return ONLY this text):

SECTION 1: PATIENT DIAGNOSIS DETAILS
Patient Name: <name or NOT FOUND>
Age: <age or NOT FOUND>

Potential Primary Diagnoses:
- Diagnosis: <diagnosis>
  ICD Code: <code>
  Reason & Source: <why selected, page/section>

Secondary Diagnoses:
- Diagnosis: <diagnosis>
  ICD Code: <code>
  Reason & Source: <snippet, page/section>

Missing any diagnosis is an audit failure.
    `;

    const response = await fetch(
        `${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`,
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: extractionPrompt },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }]
            })
        }
    );

    if (!response.ok) {
        throw new Error("Step 1 (Extraction) failed: " + response.statusText);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}


// --- CALL 2: AUDIT DATA (RAG + REASONING) ---
async function callGeminiAuditor(extractedText) {
    
    // 1. Construct the System Prompt
    const auditorSystemPrompt = `
You are an Expert ICD-10-CM Medical Coding Auditor and Compliance Officer.
Your task is to perform a complete audit and produce a correct, conflict-free, clinically validated, mandatory-rule-compliant, properly sequenced ICD-10-CM diagnostic output.

You have FOUR authoritative knowledge sources accessible via Retrieval:
1. File A — ICD-10-CM Excel Database
2. File B — ICD-10-CM Tabular List PDF
3. File C — ICD-10 Potential Primary Diagnosis Codes
4. File D — Coding Tip File

======================================================================
STRICT RULE — POTENTIAL PRIMARY LOGIC
======================================================================
A diagnosis can be "potentialPrimary" ONLY IF:
• It appears under “Potential Primary Diagnosis” in the input AND
• The ICD exists in File C AND
• Clinical Group (from File C) is NOT blank
Otherwise → potentialPrimary MUST be false.

======================================================================
GLOBAL RULE — EVERY CODE MUST BE CHECKED AGAINST ALL GUIDELINES
======================================================================
For EACH ICD code you output, YOU MUST:
• Validate the ICD from File A
• Apply ALL applicable Tabular List rules from File B (Excludes1, Excludes2, Code First, Use Additional Code)
• Apply Coding Tips from File D
• Apply sequencing rules EXACTLY as mandated
• Remove any ICD code that violates a rule or creates a contradiction

======================================================================
IMPORTANT — ABOUT REASON & SOURCE
======================================================================
For each diagnosis:
• The returned JSON must include reasonSource EXACTLY as provided
• If YOU add an ICD due to a rule (Code First, Use Additional, etc.), generate a NEW reasonSource explaining why.

======================================================================
FINAL OUTPUT FORMAT (STRICT JSON)
======================================================================
[
  {
    "code": "<ICD from File A>",
    "reasonSource": "<Original text OR rule-based explanation>",
    "potentialPrimary": true or false
  }
]

STEP 1 — Normalize & Validate
STEP 2 — Apply Potential Primary Validation
STEP 3 — Apply Excludes1
STEP 4 — Apply Excludes2
STEP 5 — Apply Coding Tips (File D)
STEP 6 — Apply CODE FIRST rules
STEP 7 — Apply USE ADDITIONAL CODE rules
STEP 8 — Final sequencing and conflict removal
    `;

    // 2. Inject the output from Step 1
    const userPrompt = `
======================================================================
INPUT DIAGNOSES TO AUDIT:
======================================================================

${extractedText}
    `;

    // 3. Prepare Payload with RAG Tool
    let toolsConfig = [];
    
    // Only attach tool if ID is present
    if (VECTOR_STORE_ID) {
        toolsConfig = [{
            retrieval: {
                vertex_ai_search: {
                    datastore: VECTOR_STORE_ID 
                }
            }
        }];
    }

    const response = await fetch(
        `${GEMINI_RAG_ENDPOINT}?key=${GEMINI_API_KEY}`,
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                system_instruction: {
                    parts: [{ text: auditorSystemPrompt }]
                },
                contents: [{
                    parts: [{ text: userPrompt }]
                }],
                // Attach the RAG tool here
                tools: toolsConfig 
            })
        }
    );

    if (!response.ok) {
        const err = await response.text();
        throw new Error("Step 2 (Audit) failed: " + err);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

/* =========================================================
   HELPER FUNCTIONS & SAVE
   ========================================================= */

function showStatus(message, isError = false) {
    const status = document.getElementById("status");
    status.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
}

function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function finalizeSave() {
    const saveBtn = document.getElementById("saveBtn");
    const jsonOutput = document.getElementById("jsonOutput");
    const finalJson = jsonOutput.value;

    if (!finalJson) {
        showStatus("❌ No data to save", true);
        return;
    }

    try {
        saveBtn.disabled = true;
        saveBtn.innerText = "Saving...";
        showStatus("Saving results to Salesforce...");

        await sendToSalesforce(finalJson, CACHED_AI_TIME);

        showStatus("✅ Saved successfully to Salesforce!", false);
        saveBtn.innerText = "Saved";
        
        setTimeout(() => {
             saveBtn.disabled = false;
             saveBtn.innerText = "Save to Salesforce";
        }, 3000);

    } catch (error) {
        console.error(error);
        showStatus("❌ Save failed: " + error.message, true);
        saveBtn.disabled = false;
        saveBtn.innerText = "Save to Salesforce";
    }
}

async function sendToSalesforce(rawJson, aiTimeSeconds) {
    const endpoint = `${SF_BASE_URL}/services/apexrest/oasis/ai-result`;

    const response = await fetch(endpoint, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + SF_SESSION_ID,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            chartId: CHART_ID,
            rawJson: rawJson,
            aiTimeSeconds: aiTimeSeconds
        })
    });

    if (!response.ok) {
        const text = await response.text();
        throw new Error("Salesforce save failed: " + text);
    }
}
</script>

</body>
</html>
