<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI OASIS Analyzer</title>

<style>
    /* --- GLOBAL LAYOUT (Existing Dark Theme) --- */
    body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #0b1f2a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #ffffff;
    }

    .card {
        width: 600px; /* Widened slightly to fit file list comfortably */
        background: #081821;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 20px 50px rgba(0,0,0,.45);
        margin: 20px 0;
        position: relative;
        border: 1px solid #1f3a4d;
    }

    h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-weight: 600;
        text-align: center;
        letter-spacing: 0.5px;
        color: #e0e0e0;
    }

    p {
        font-size: 14px;
        opacity: 0.7;
        text-align: center;
        margin-bottom: 25px;
        color: #8daac2;
    }

    /* --- FILE INPUT --- */
    /* Hidden file input, triggered by a styled label if needed, 
       but standard input is kept for functionality. */
    input[type="file"] {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px dashed #4fa3ff;
        background: #06141c;
        color: #fff;
        cursor: pointer;
        box-sizing: border-box;
        margin-bottom: 20px;
        transition: border-color 0.3s;
    }
    input[type="file"]:hover {
        border-color: #7abaff;
    }

    /* --- NEW FILE LIST DESIGN (Matching Screenshot) --- */
    .file-section-header {
        font-size: 14px;
        color: #4fa3ff; /* Salesforce Blue-ish */
        font-weight: 700;
        margin-bottom: 10px;
        display: none; /* Hidden until files are added */
    }

    #fileListContainer {
        display: none;
        margin-bottom: 25px;
        background: #f3f3f3; /* Light container background like screenshot? Or keep transparent */
        background: transparent;
    }

    .file-item {
        background: #ffffff; /* White Card */
        border: 1px solid #d8dde6;
        border-radius: 4px;
        padding: 10px 15px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #16325c; /* Dark text for contrast on white card */
        font-size: 13px;
        font-weight: 500;
        overflow: hidden;
    }

    .file-icon {
        color: #706e6b;
        font-size: 16px;
    }

    .file-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 350px;
    }

    /* Trash Button Style */
    .remove-btn {
        background: #ffffff;
        border: 1px solid #dddbda;
        border-radius: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #706e6b;
        transition: all 0.2s;
    }

    .remove-btn:hover {
        border-color: #005fb2;
        color: #005fb2;
        background: #f4f6f9;
    }

    /* --- ANALYZE BUTTON (Centered Blue) --- */
    .action-row {
        text-align: center;
        margin-top: 20px;
    }

    button.analyze-btn {
        background: #0176d3; /* Salesforce Blue */
        color: white;
        border: none;
        padding: 10px 24px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        min-width: 120px;
    }

    button.analyze-btn:hover {
        background: #014486;
    }

    button.analyze-btn:disabled {
        background: #c9c7c5;
        cursor: not-allowed;
    }

    /* --- RESULTS & PROGRESS --- */
    .save-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #4cff9f, #27ae60);
        color: #052e16;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        margin-top: 15px;
        cursor: pointer;
    }

    .status {
        margin-top: 15px;
        font-size: 13px;
        text-align: center;
        min-height: 20px;
    }
    .success { color: #4cff9f; }
    .error { color: #ff7a7a; }

    /* Progress Bar */
    #progressWrapper {
        display: none;
        margin-top: 20px;
        width: 100%;
    }
    .progress-container {
        width: 100%;
        height: 8px;
        background-color: #0f2735;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 5px;
    }
    .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4fa3ff, #00d2ff);
        transition: width 0.4s ease;
    }
    .progress-label {
        font-size: 12px;
        color: #4fa3ff;
        display: flex;
        justify-content: space-between;
    }

    /* Results */
    #resultArea {
        display: none;
        margin-top: 25px;
        border-top: 1px solid #1f3a4d;
        padding-top: 20px;
    }
    textarea {
        width: 100%;
        height: 250px;
        background: #050e13;
        color: #a6e22e;
        border: 1px solid #1f3a4d;
        border-radius: 6px;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
        resize: vertical;
        box-sizing: border-box;
    }
    label {
        font-size: 12px;
        color: #8daac2;
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        text-transform: uppercase;
    }
</style>
</head>

<body>

<div class="card">
    <h2>AI Non - OASIS Analyzer</h2>
    <p>Extraction & ICD-10 Compliance Audit</p>

    <div id="loadingMessage" style="text-align:center; color:#4fa3ff; margin-bottom:15px; font-weight:500;">
        Connecting to Salesforce...
    </div>

    <div id="mainControls" style="display:none;">
        
        <label>Select Documents:</label>
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple onchange="handleFileSelect(this)" />
        
        <div id="fileSectionHeader" class="file-section-header">
            Uploaded Files (<span id="fileCount">0</span>)
        </div>

        <div id="fileListContainer">
            </div>

        <div class="action-row">
            <button id="analyzeBtn" class="analyze-btn" onclick="startAnalysis()">
                Analyze Files
            </button>
        </div>

        <div id="progressWrapper">
            <div class="progress-label">
                <span id="progressText">Initializing...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-container">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <div id="status" class="status"></div>

    <div id="resultArea">
        <label>Final Audited Result (ICD-10 Compliant):</label>
        <textarea id="jsonOutput" readonly></textarea>
        
        <button id="saveBtn" class="save-btn" onclick="finalizeSave()">
            Save to Salesforce
        </button>
    </div>
</div>

<script>
/* =========================================================
   GLOBAL CONTEXT
   ========================================================= */

let CHART_ID = null;
let GEMINI_API_KEY = null;
let SF_SESSION_ID = null;
let SF_BASE_URL = null; 
let VECTOR_STORE_ID = null;
let CACHED_AI_TIME = 0;

// Array to store actual File objects
let selectedFiles = [];

const GEMINI_VISION_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent"; 
const GEMINI_RAG_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent"; 

/* =========================================================
   SALESFORCE CONNECTION
   ========================================================= */

window.addEventListener("message", (event) => {
    if (event.data && event.data.type === "SF_CONTEXT") {
        console.log("‚úÖ Received Context from Salesforce");
        
        CHART_ID = event.data.recordId;
        GEMINI_API_KEY = event.data.apiKey;
        SF_SESSION_ID = event.data.sessionId;
        SF_BASE_URL = event.data.baseUrl;
        VECTOR_STORE_ID = event.data.vectorStoreId;
        
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("mainControls").style.display = "block";
    }
});

/* =========================================================
   FILE UI LOGIC (MATCHING SCREENSHOT)
   ========================================================= */

function handleFileSelect(inputElement) {
    if (inputElement.files && inputElement.files.length > 0) {
        // Append new files to existing list
        for (let i = 0; i < inputElement.files.length; i++) {
            selectedFiles.push(inputElement.files[i]);
        }
        renderFileList();
        
        // Reset input value so same file can be selected again if user wants
        inputElement.value = ""; 
    }
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderFileList();
}

function renderFileList() {
    const container = document.getElementById("fileListContainer");
    const header = document.getElementById("fileSectionHeader");
    const countSpan = document.getElementById("fileCount");
    
    container.innerHTML = ""; // Clear current view

    if (selectedFiles.length === 0) {
        container.style.display = "none";
        header.style.display = "none";
        return;
    }

    // Show Header and Container
    header.style.display = "block";
    container.style.display = "block";
    countSpan.innerText = selectedFiles.length;

    // Generate Cards
    selectedFiles.forEach((file, index) => {
        const item = document.createElement("div");
        item.className = "file-item";
        
        // Trash Icon SVG
        const trashIconSvg = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        `;

        item.innerHTML = `
            <div class="file-info">
                <span class="file-icon">üìÑ</span> 
                <span class="file-name">${file.name}</span>
            </div>
            <button class="remove-btn" onclick="removeFile(${index})" title="Remove File">
                ${trashIconSvg}
            </button>
        `;
        container.appendChild(item);
    });
}

/* =========================================================
   PROGRESS BAR HELPER
   ========================================================= */

function updateProgress(percent, text) {
    const wrapper = document.getElementById("progressWrapper");
    const fill = document.getElementById("progressFill");
    const textSpan = document.getElementById("progressText");
    const percentSpan = document.getElementById("progressPercent");

    wrapper.style.display = "block";
    fill.style.width = percent + "%";
    if (text) textSpan.innerText = text;
    percentSpan.innerText = percent + "%";
}

/* =========================================================
   MAIN ANALYSIS LOGIC
   ========================================================= */

async function startAnalysis() {
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultArea = document.getElementById("resultArea");
    const jsonOutput = document.getElementById("jsonOutput");
    
    // UI Reset
    resultArea.style.display = "none";
    jsonOutput.value = "";
    showStatus(""); 
    
    // Validations
    if (!CHART_ID || !GEMINI_API_KEY) {
        showStatus("‚ùå Configuration missing. Refresh Salesforce page.", true);
        return;
    }

    if (selectedFiles.length === 0) {
        showStatus("‚ùå Please upload at least one file.", true);
        return;
    }

    try {
        analyzeBtn.disabled = true;
        analyzeBtn.innerText = "Analyzing...";
        
        updateProgress(5, "Initializing Batch...");
        const startTime = Date.now();
        
        // --- STEP 1: READ FILES ---
        updateProgress(10, `Processing ${selectedFiles.length} file(s)...`);
        
        // Convert all files to Base64
        const filePromises = selectedFiles.map(file => readFileAsBase64(file));
        const fileDataArray = await Promise.all(filePromises);

        // --- STEP 2: VISION EXTRACTION ---
        updateProgress(35, "AI Vision: Scanning Documents...");
        const rawExtraction = await callGeminiVisionMulti(fileDataArray);
        console.log("Vision Output:", rawExtraction);

        // --- STEP 3: AUDIT & COMPLIANCE ---
        updateProgress(70, "AI Auditor: Validating ICD-10 Rules...");
        const finalAuditJson = await callGeminiAuditor(rawExtraction);
        
        updateProgress(90, "Finalizing Results...");
        CACHED_AI_TIME = Math.floor((Date.now() - startTime) / 1000);

        // --- STEP 4: DISPLAY ---
        let prettyJson = finalAuditJson;
        try {
            const cleanJson = finalAuditJson.replace(/```json/g, "").replace(/```/g, "").trim();
            const parsed = JSON.parse(cleanJson);
            prettyJson = JSON.stringify(parsed, null, 4);
        } catch (e) { console.warn("Formatting failed"); }

        jsonOutput.value = prettyJson;
        resultArea.style.display = "block";
        
        updateProgress(100, "Complete");
        showStatus("‚úÖ Analysis Complete.", false);

    } catch (error) {
        console.error(error);
        showStatus("‚ùå " + error.message, true);
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerText = "Analyze Files";
    }
}

/* =========================================================
   API CALLS
   ========================================================= */

async function callGeminiVisionMulti(fileDataArray) {
    const extractionPrompt = `
You are a clinical document extraction auditor.
Process ALL attached files as a single patient chart.

Task:
- Extract diagnoses EXACTLY as written.
- Identify potential primary diagnoses.
- Provide source file name/page for every finding.

OUTPUT FORMAT (Return ONLY this text):
SECTION 1: PATIENT DETAILS
Name: <name> | Age: <age>

Potential Primary Diagnoses:
- Diagnosis: <dx>
  ICD Code: <code>
  Reason & Source: <reason, filename>

Secondary Diagnoses:
- Diagnosis: <dx>
  ICD Code: <code>
  Reason & Source: <snippet, filename>
    `;

    const parts = [{ text: extractionPrompt }];
    fileDataArray.forEach(f => {
        parts.push({
            inlineData: { mimeType: f.mimeType, data: f.base64 }
        });
    });

    const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: parts }] })
    });

    if (!response.ok) throw new Error("Vision Step Failed");
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

async function callGeminiAuditor(extractedText) {
    const auditorSystemPrompt = `
You are an Expert ICD-10-CM Auditor.
Audit the input diagnoses against mandatory rules (Excludes1, Sequencing, Code First).

OUTPUT JSON:
[ { "code": "...", "reasonSource": "...", "potentialPrimary": true/false } ]
    `;

    const userPrompt = `INPUT:\n${extractedText}`;

    let toolsConfig = [];
    if (VECTOR_STORE_ID) {
        toolsConfig = [{ retrieval: { vertex_ai_search: { datastore: VECTOR_STORE_ID } } }];
    }

    const response = await fetch(`${GEMINI_RAG_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            system_instruction: { parts: [{ text: auditorSystemPrompt }] },
            contents: [{ parts: [{ text: userPrompt }] }],
            tools: toolsConfig
        })
    });

    if (!response.ok) throw new Error("Audit Step Failed");
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

/* =========================================================
   HELPERS
   ========================================================= */

function showStatus(message, isError = false) {
    const status = document.getElementById("status");
    status.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
}

function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
            mimeType: file.type,
            base64: reader.result.split(",")[1],
            name: file.name
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function finalizeSave() {
    const saveBtn = document.getElementById("saveBtn");
    const jsonOutput = document.getElementById("jsonOutput");
    
    try {
        saveBtn.disabled = true;
        saveBtn.innerText = "Saving...";
        
        await sendToSalesforce(jsonOutput.value, CACHED_AI_TIME);
        
        showStatus("‚úÖ Saved to Salesforce!", false);
        saveBtn.innerText = "Saved";
        setTimeout(() => { saveBtn.disabled = false; saveBtn.innerText = "Save to Salesforce"; }, 3000);
    } catch (e) {
        showStatus("‚ùå Save failed: " + e.message, true);
        saveBtn.disabled = false;
        saveBtn.innerText = "Save to Salesforce";
    }
}

async function sendToSalesforce(rawJson, aiTimeSeconds) {
    const endpoint =  `${SF_BASE_URL}/services/apexrest/non-oasis/ai-result`;
    const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Authorization": "Bearer " + SF_SESSION_ID, "Content-Type": "application/json" },
        body: JSON.stringify({ chartId: CHART_ID, rawJson: rawJson, aiTimeSeconds: aiTimeSeconds })
    });
    if (!response.ok) throw new Error(await response.text());
}
</script>

</body>
</html>

