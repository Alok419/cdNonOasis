<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>AI OASIS Analyzer</title>
        <style>
    /* --- GLOBAL LAYOUT (Dark Theme) --- */
    body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #0b1f2a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #ffffff;
    }

    .card {
        width: 600px; /* Widened slightly to accommodate file list */
        background: #081821;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 20px 50px rgba(0,0,0,.45);
        margin: 20px 0;
        border: 1px solid #1f3a4d;
    }

    h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-weight: 600;
        text-align: center;
        color: #e0e0e0;
    }

    p {
        font-size: 14px;
        opacity: 0.85;
        text-align: center;
        margin-bottom: 20px;
        color: #8daac2;
    }

    /* --- FILE INPUT --- */
    input[type="file"] {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px dashed #4fa3ff;
        background: #06141c;
        color: #fff;
        cursor: pointer;
        box-sizing: border-box;
        margin-bottom: 10px;
    }
    input[type="file"]:hover {
        border-color: #7abaff;
    }

    /* --- FILE LIST DESIGN --- */
    .file-section-header {
        font-size: 14px;
        color: #4fa3ff;
        font-weight: 700;
        margin-bottom: 10px;
        display: none;
    }

    #fileListContainer {
        display: none;
        margin-bottom: 25px;
        background: transparent;
    }

    .file-item {
        background: #ffffff;
        border: 1px solid #d8dde6;
        border-radius: 4px;
        padding: 10px 15px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #16325c;
        font-size: 13px;
        font-weight: 500;
        overflow: hidden;
    }

    .file-icon {
        color: #706e6b;
        font-size: 16px;
    }

    .file-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 350px;
    }

    /* Trash Button Style */
    .remove-btn {
        background: #ffffff;
        border: 1px solid #dddbda;
        border-radius: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #706e6b;
        transition: all 0.2s;
    }

    .remove-btn:hover {
        border-color: #005fb2;
        color: #005fb2;
        background: #f4f6f9;
    }

    /* --- BUTTONS --- */
    button {
        /* margin-top: 10px; */
        width: 100%;
        padding: 12px;
        background: #4fa3ff;
        border: none;
        border-radius: 8px;
        color: #000;
        font-weight: bold;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.3s;
    }

    button:hover {
        background: #7abaff;
    }

    button:disabled {
        background: #6b6b6b;
        cursor: not-allowed;
        color: #d1d1d1;
    }

    /* Green Save Button style */
    .save-btn {
        background: #4cff9f;
        color: #00522e;
        margin-top: 10px;
    }
    .save-btn:hover {
        background: #7dfcbd;
    }

    .status {
        margin-top: 16px;
        font-size: 14px;
        min-height: 20px;
        text-align: center;
    }

    .success {
        color: #4cff9f;
    }

    .error {
        color: #ff7a7a;
    }

    /* JSON Preview Area Styles */
    #resultArea {
        display: none;
        margin-top: 20px;
        border-top: 1px solid #1f3a4d;
        padding-top: 15px;
    }

    textarea {
        width: 100%;
        height: 250px;
        background: #050e13;
        color: #a6e22e;
        border: 1px solid #1f3a4d;
        border-radius: 6px;
        padding: 10px;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 12px;
        resize: vertical;
        box-sizing: border-box;
    }

    label {
        font-size: 12px;
        color: #aaa;
        display: block;
        margin-bottom: 5px;
    }
        </style>
    </head>
    <body>
        <div class="card">
            <h2>AI OASIS Analyzer New</h2>
            <p>Upload OASIS document(s) to extract data</p>
            <div id="loadingMessage" style="text-align:center; color:#4fa3ff; margin-bottom:15px;">
                Connecting to Salesforce...
            </div>
            <!-- <div id="mainControls" >
        <label>Select Document(s):</label>
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple onchange="handleFileSelect(this)" />

        <div id="fileSectionHeader" class="file-section-header">
            Uploaded Files (<span id="fileCount">0</span>)
        </div>

        <div id="fileListContainer">
        </div>

        <button id="analyzeBtn" onclick="startAnalysis()">
            Analyze Document
        </button>
    </div> -->
            <style>
                 /* Card Container */
            .upload-card {
                background: linear-gradient(180deg, #0c2230, #081821);
                border: 1px solid #1f3a4d;
                border-radius: 14px;
                padding: 22px;
            }

            /* Header */
            .upload-header {
                display: flex;
                gap: 12px;
                margin-bottom: 18px;
            }

            .upload-icon {
                width: 44px;
                height: 44px;
                border-radius: 10px;
                background: rgba(79,163,255,0.15);
                color: #7abaff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 22px;
            }

            .upload-title {
                font-size: 15px;
                font-weight: 600;
                color: #e4f1ff;
            }

            .upload-subtitle {
                font-size: 12px;
                color: #9bb9d4;
            }

            /* Upload Zone */
            .upload-zone {
                border: 2px dashed #355a74;
                border-radius: 12px;
                padding: 26px;
                text-align: center;
                background: #06141c;
                cursor: pointer;
                transition: all 0.25s ease;
                margin-bottom: 16px;
            }

            .upload-zone:hover {
                border-color: #7abaff;
                background: #081d2a;
            }

            .upload-zone-icon {
                font-size: 30px;
                color: #7abaff;
                margin-bottom: 6px;
            }

            .upload-zone-text {
                font-size: 13px;
                font-weight: 600;
                color: #d6eaff;
            }

            .upload-zone-hint {
                font-size: 11px;
                color: #8fbce6;
                margin-top: 4px;
            }

            /* File Section Header */
            .file-section-header {
                font-size: 13px;
                font-weight: 600;
                color: #cfe7ff;
                margin-bottom: 10px;
            }

            /* File List */
            .file-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 18px;
            }

            /* Individual File Item (use from JS) */
            .file-item {
                display: flex;
                align-items: center;
                gap: 10px;
                background: #ffffff;
                border-radius: 10px;
                padding: 8px 12px;
            }

            .file-item-name {
                flex: 1;
                font-size: 13px;
                font-weight: 600;
                color: #1b1b1b;
            }

            .file-item-size {
                font-size: 11px;
                color: #606060;
            }

            /* Analyze Button */
            .analyze-btn {
                width: 100%;
                padding: 13px;
                border-radius: 10px;
                background: linear-gradient(135deg, #4fa3ff, #7abaff);
                border: none;
                font-size: 14px;
                font-weight: 600;
                color: #04121a;
                cursor: pointer;
                transition: all 0.25s ease;
            }

            .analyze-btn:disabled {
                background: #6b6b6b;
                color: #d1d1d1;
                /* cursor: not-allowed; */
            }

            .analyze-btn:not(:disabled):hover {
                transform: translateY(-1px);
                box-shadow: 0 12px 30px rgba(79,163,255,0.35);
            }

            /* File list container */
            #fileListContainer {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 16px;
            }

            /* File item card */
            .file-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: #ffffff;
                border-radius: 12px;
                padding: 10px 14px;
                border: 1px solid #e6e6e6;
                transition: all 0.2s ease;
            }

            .file-item:hover {
                box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            }

            /* Left section */
            .file-left {
                display: flex;
                align-items: center;
                gap: 12px;
                min-width: 0;
            }

            /* File icon */
            .file-type-icon {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                background: #eef5ff;
                color: #4fa3ff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
            }

            /* File metadata */
            .file-meta {
                display: flex;
                flex-direction: column;
                min-width: 0;
            }

            .file-name {
                font-size: 13px;
                font-weight: 600;
                color: #1e1e1e;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 260px;
            }

            .file-size {
                font-size: 11px;
                color: #6b6b6b;
            }

            /* Remove button */
            .remove-btn {
                background: transparent;
                border: none;
                color: #9b9b9b;
                cursor: pointer;
                padding: 6px;
                border-radius: 6px;
                transition: all 0.2s ease;
            }

            .remove-btn:hover {
                background: #ffecec;
                color: #d64545;
            }
            /* Disable entire upload area */
            .upload-disabled {
                pointer-events: none;
                opacity: 0.45;
            }

            /* Optional: show loading cursor */
            .upload-disabled * {
                cursor: wait !important;
            }
            </style>
            <div id="mainControls" class="upload-card" style="display:none;">
                <!-- Header -->
                <div class="upload-header">
                    <div class="upload-icon">üìÑ</div>
                    <div>
                        <div class="upload-title">Upload OASIS Documents</div>
                        <div class="upload-subtitle">
                            Select or drag & drop patient assessment files
                        </div>
                    </div>
                </div>
                <!-- Upload Area -->
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <input
                        type="file"
                        id="fileInput"
                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                        multiple
                        onchange="handleFileSelect(this)"
                        hidden
                    >
                    <div class="upload-zone-icon">‚¨ÜÔ∏è</div>
                    <div class="upload-zone-text">
                        Click to upload or drag files here
                    </div>
                    <div class="upload-zone-hint">
                        PDF, JPG, PNG, DOC, DOCX
                    </div>
                </div>
                <!-- File Section Header -->
                <div id="fileSectionHeader" class="file-section-header">
                    Uploaded Files (
                    <span id="fileCount">0</span>
                    )
                </div>
                <!-- File List -->
                <div id="fileListContainer" class="file-list"></div>
                <!-- Action Button -->
                <button id="analyzeBtn" class="analyze-btn" onclick="startAnalysis()">
                    Analyze Documents
                </button>
            </div>
            <!-- Progress Bar -->
            <div id="progressWrapper" style="display:none; margin-top:20px;">
                <div style="font-size:13px; margin-bottom:6px; color:#9bb9d4;">
                    Analyzing documents...
                    <span id="progressPercent">0%</span>
                </div>
                <div style="background:#102a3a; border-radius:10px; overflow:hidden; height:10px;">
                    <div id="progressBar" style="height:100%; width:0%; background:linear-gradient(90deg,#4fa3ff,#7abaff); transition:width 0.4s ease;"></div>
                </div>
            </div>
            <div id="status" class="status"></div>
            <div id="resultArea">
                <div style="display :none">
                    <label>Review AI Extraction Result:</label>
                    <textarea id="jsonOutput"></textarea>
                </div>
                <button id="saveBtn" class="save-btn" onclick="finalizeSave()">
                    Save Data & Files
                </button>
            </div>
        </div>
        <script>

                // function showProgress() {
                //     document.getElementById("progressWrapper").style.display = "block";
                //     updateProgress(0);
                // }

                // function hideProgress() {
                //     document.getElementById("progressWrapper").style.display = "none";
                // }

                // function updateProgress(percent) {
                //     const bar = document.getElementById("progressBar");
                //     const label = document.getElementById("progressPercent");
                //     bar.style.width = percent + "%";
                //     label.innerText = percent + "%";
                // }

                let progressValue = 1;
let progressTimer = null;

function showProgress() {
    progressValue = 1;
    updateProgress(progressValue);
    document.getElementById("progressWrapper").style.display = "block";
}

function hideProgress() {
    clearInterval(progressTimer);
    progressTimer = null;
    document.getElementById("progressWrapper").style.display = "none";
}

function updateProgress(value) {
    const bar = document.getElementById("progressBar");
    const label = document.getElementById("progressPercent");

    const safeValue = Math.min(100, Math.max(1, value));
    bar.style.width = safeValue + "%";
    label.innerText = safeValue + "%";
}

function startAutoProgress(to = 1, speed = 300) {
    clearInterval(progressTimer);

    progressTimer = setInterval(() => {
        if (progressValue < to) {
            progressValue += 1;
            updateProgress(progressValue);
        }
    }, speed);
}




            function disableUploadUI() {
                document.getElementById("mainControls").classList.add("upload-disabled");
            }

            function enableUploadUI() {
                document.getElementById("mainControls").classList.remove("upload-disabled");
            }

/* =========================================================
   GLOBAL CONTEXT (Populated via PostMessage)
   ========================================================= */

let CHART_ID = null;
let GEMINI_API_KEY = null;
let SF_SESSION_ID = null;
let SF_BASE_URL = null; 
let CACHED_AI_TIME = 0;

// Array to store actual File objects
let selectedFiles = [];

// Uses Gemini 1.5 Flash for speed/cost balance, change to Pro if needed
const GEMINI_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent"; 

/* =========================================================
   LISTENER: RECEIVE DATA FROM SALESFORCE LWC
   ========================================================= */

window.addEventListener("message", (event) => {
    if (event.data && event.data.type === "SF_CONTEXT") {
        console.log("‚úÖ Received Context from Salesforce");
        
        CHART_ID = event.data.recordId;
        GEMINI_API_KEY = event.data.apiKey;
        SF_SESSION_ID = event.data.sessionId;
        SF_BASE_URL = event.data.baseUrl;
        
        // Update UI
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("mainControls").style.display = "block";
        
        showStatus("‚úÖ Connected. Ready to analyze.", false);
    }
});

/* =========================================================
   FILE UI LOGIC
   ========================================================= */

function handleFileSelect(inputElement) {
    if (inputElement.files && inputElement.files.length > 0) {
        // Append new files to existing list
        for (let i = 0; i < inputElement.files.length; i++) {
            selectedFiles.push(inputElement.files[i]);
        }
        renderFileList();
        
        // Reset input value so same file can be selected again if user wants
        inputElement.value = ""; 
    }
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderFileList();
}


function renderFileList() {
    const container = document.getElementById("fileListContainer");
    const header = document.getElementById("fileSectionHeader");
    const countSpan = document.getElementById("fileCount");

    container.innerHTML = "";

    if (selectedFiles.length === 0) {
        container.style.display = "none";
        header.style.display = "none";
        return;
    }

    header.style.display = "block";
    container.style.display = "flex";
    countSpan.innerText = selectedFiles.length;

    selectedFiles.forEach((file, index) => {
        const item = document.createElement("div");
        item.className = "file-item";

        const sizeMB = (file.size / 1024 / 1024).toFixed(2);

        item.innerHTML = `
            <div class="file-left">
                <div class="file-type-icon">üìÑ</div>
                <div class="file-meta">
                    <div class="file-name" title="${file.name}">
                        ${file.name}
                    </div>
                    <div class="file-size">
                        ${sizeMB} MB
                    </div>
                </div>
            </div>

            <button class="remove-btn" onclick="removeFile(${index})" title="Remove file">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                </svg>
            </button>
        `;

        container.appendChild(item);
    });
}

/* =========================================================
   MAIN LOGIC
   ========================================================= */

async function startAnalysis() {
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultArea = document.getElementById("resultArea");
    const jsonOutput = document.getElementById("jsonOutput");
    
    // Reset UI
    resultArea.style.display = "none";
    jsonOutput.value = "";
    
    if (!CHART_ID || !GEMINI_API_KEY) {
        showStatus("‚ùå Configuration missing. Please refresh Salesforce page.", true);
        return;
    }

    if (selectedFiles.length === 0) {
        showStatus("‚ùå Please select at least one file.", true);
        return;
    }

    try {
    analyzeBtn.disabled = true;
    disableUploadUI();

    // 1Ô∏è‚É£ Show progress and start auto count
    showProgress();              // starts at 1%
    startAutoProgress(90, 250);  // auto count till 90%

    // 2Ô∏è‚É£ Read files
    showStatus(`Reading ${selectedFiles.length} file(s)...`);
    const fileDataArray = await Promise.all(
        selectedFiles.map(file => readFileAsBase64(file))
    );

    // 3Ô∏è‚É£ AI processing
    showStatus("Running AI analysis...");
    const startTime = Date.now();

    const rawResult = await callGemini(GEMINI_API_KEY, fileDataArray);

    CACHED_AI_TIME = Math.floor((Date.now() - startTime) / 1000);

    // 4Ô∏è‚É£ Stop auto progress & finish to 100%
    clearInterval(progressTimer);
    progressValue = 100;
    updateProgress(100);

    // 5Ô∏è‚É£ Pretty print JSON
    let prettyJson = rawResult;
    try {
        const cleanJson = rawResult
            .replace(/```json/g, "")
            .replace(/```/g, "")
            .trim();
        prettyJson = JSON.stringify(JSON.parse(cleanJson), null, 4);
    } catch {}

    document.getElementById("jsonOutput").value = prettyJson;
    document.getElementById("resultArea").style.display = "block";

    showStatus("‚úÖ Analysis complete. Please review data below.", false);

    // 6Ô∏è‚É£ Hide progress & upload UI
    setTimeout(() => {
        hideProgress();
        document.getElementById("mainControls").style.display = "none";
    }, 600);

    analyzeBtn.disabled = false;
    enableUploadUI();

} catch (error) {
    console.error(error);

    clearInterval(progressTimer);
    hideProgress();

    showStatus("‚ùå " + error.message, true);
    analyzeBtn.disabled = false;
    enableUploadUI();
}


}

async function finalizeSave() {
    const saveBtn = document.getElementById("saveBtn");
    const jsonOutput = document.getElementById("jsonOutput");
    const finalJson = jsonOutput.value;

    if (!finalJson) {
        showStatus("‚ùå No data to save", true);
        return;
    }

    try {
        saveBtn.disabled = true;
        
        // 1. Save Data (JSON)
        saveBtn.innerText = "Saving Data...";
        showStatus("Saving extracted data to Salesforce...");
        await sendToSalesforce(finalJson, CACHED_AI_TIME);

        // 2. Upload Files
        if (selectedFiles.length > 0) {
            saveBtn.innerText = `Uploading ${selectedFiles.length} Files...`;
            await saveFilesToSalesforceRecord();
        }

        showStatus("‚úÖ Data & Files Saved Successfully!", false);
        const baseUrl = window.location.origin;
        console.log("Base Url:======================"+ baseUrl);

        setTimeout(() => {
            window.location.href = `${SF_BASE_URL}/lightning/r/Chart__c/${this.CHART_ID}/view`;
        }, 800);
 
        saveBtn.innerText = "Saved";
        
        
        setTimeout(() => {
             saveBtn.disabled = true;
             saveBtn.innerText = "Save Data & Files to Salesforce";
        }, 3000);

    } catch (error) {
        console.error(error);
        showStatus("‚ùå Save failed: " + error.message, true);
        saveBtn.disabled = false;
        saveBtn.innerText = "Save Data & Files to Salesforce";
    }
}

/* =========================================================
   HELPER FUNCTIONS & API CALLS
   ========================================================= */

function showStatus(message, isError = false) {
    const status = document.getElementById("status");
    status.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
}

function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
            mimeType: file.type,
            base64: reader.result.split(",")[1],
            name: file.name
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Call Gemini (Client Side) - Modified to handle Multiple Files
async function callGemini(apiKey, fileDataArray) {
    
    // THE FULL PROMPT INSTRUCTIONS
    const instructions = `
You are a specialized Clinical Document Extractor. Your job is to extract data from an OASIS-E1 Home Health Assessment PDF.

VISUAL INSTRUCTIONS
This is a visual extraction task. Do not rely solely on text stream order. Look at the layout.
Identify selected values by looking for: ‚òë (checked box), [X] (marked box), ‚ñ† (filled box), or circled numbers.
Ignore unchecked boxes (‚òê, [ ]).

DATA FORMATTING RULES (CRITICAL)
NO LEADING ZEROS: If a value is "01", return "1". If "02", return "2". (Exception: Return "0" if the value is exactly zero). EXCEPTION FOR GG CODES: For GG items (e.g., GG0130, GG0170), KEEP the leading zero (e.g., return "06", "05", "01").
ONLY CODES: For M-Items and GG-Items, return ONLY the numeric code (e.g., "1", "06"), do NOT return the text description.
MULTI-SELECT: If multiple boxes are checked, separate with commas (e.g., "1, 2").
DATES: Extract dates strictly in YYYY-MM-DD format. If a date is missing, return "N/A".

SECTION SPECIFIC RULES
M-Items & B/D-Items:
Find the question ID (e.g., M1830, B1000).
Find the option that is VISUALLY marked.
Extract the numeric code associated with that option.

ITEMS TO EXTRACT
If an item is not found or not visually marked, return "N/A".

--- CHART DATA ---
M0030 (Start of Care Date) -> Return YYYY-MM-DD
M0032 (Resumption of Care Date) -> Return YYYY-MM-DD
M0060 (Zip Code) -> Return ONLY the first 5 characters. Ignore any suffix.
M0110 (Episode Timing) -> Return code "1" (Early) or "2" (Later)
M1005 (Inpatient Discharge Date) -> Return YYYY-MM-DD
M0069 (Gender) -> Return code "1" (Male) or "2" (Female).
M0080 (Discipline) -> Return code "1" (RN), "2" (PT), "3" (SLP/ST), "4" (OT).

--- PLAN OF CARE / ORDERS ---
Activities Permitted:
Look for the header "Activities Permitted".
Return a comma-separated list of EVERY checkbox that is visually marked.
DME:
Look for the header "DME".
Return a comma-separated list of EVERY checkbox that is visually marked.

--- OASIS ITEMS ---
M0090 (Date Assessment Completed) -> Return YYYY-MM-DD
M1000 (Inpatient Discharge History - list all checked numbers 1-7)
M1033 (Risk for Hospitalization ‚Äì list all checked numbers)
B1000 (Vision)
M1400 (Dyspnea)
M1700 (Cognitive Functioning)
M1710 (When Confused)
M1720 (When Anxious)
M1740 (Cognitive/Behavioral Symptoms ‚Äì list all checked numbers)
M1745 (Disruptive Behavior)
M1800 (Grooming)
M1810 (Upper Body Dressing)
M1820 (Lower Body Dressing)
M1830 (Bathing)
M1840 (Toilet Transfer)
M1845 (Toileting Hygiene)
M1850 (Transferring)
M1860 (Ambulation)
M1870 (Feeding)
M2020 (Oral Medications)
J0530 (Pain Interference with Activities)

--- GG ITEMS (SELF-CARE & MOBILITY) ---
Extract the "SOC/ROC Performance" code (e.g., 06, 05, 04, 03, 02, 01, 07, 09, 10, 88) for the following items:
GG0130 B (Oral Hygiene)
GG0130 C (Toileting Hygiene)
GG0130 E (Shower/Bathe Self)
GG0130 F (Upper Body Dressing)
GG0130 G (Lower Body Dressing)
GG0130 H (Footwear)
GG0170 A (Roll left/right)
GG0170 B (Sit to lying)
GG0170 C (Lying to sitting)
GG0170 D (Sit to stand)
GG0170 E (Chair/bed transfer)
GG0170 F (Toilet transfer)
GG0170 I (Walk 10 feet)
GG0170 J (Walk 50 feet w/ turns)
GG0170 K (Walk 150 feet)
GG0170 L (Walk 10 feet uneven)
GG0170 M (1 step/curb)
GG0170 N (4 steps)
GG0170 O (12 steps)
GG0170 R (Wheel 50 feet)
GG0170 S (Wheel 150 feet)

--- D0150 PATIENT MOOD INTERVIEW ---
This section has two columns. Extract the numeric code for checks in Row A and Row B.
Row A (Little interest): Col 1 (Symptom), Col 2 (Frequency)
Row B (Feeling down): Col 1 (Symptom), Col 2 (Frequency)

SALESFORCE OUTPUT REQUIREMENT (MANDATORY)
You must identify values using the OASIS codes above, but the FINAL OUTPUT must use the specific JSON keys below.

Use this mapping EXACTLY:
SOC_Date -> M0030 (YYYY-MM-DD)
ROC_Date -> M0032 (YYYY-MM-DD)
Zip_Code -> M0060 (First 5 digits only)
Episode_Timing -> M0110 (1 or 2)
M0069 -> M0069 (1 or 2)
M0080 -> M0080 (1, 2, 3, or 4)
Inpatient_Discharge_Date -> M1005 (YYYY-MM-DD)
M0090_Date_Assessment_Completed -> M0090 (YYYY-MM-DD)
M1000_Discharge_History -> M1000 (Comma separated list of codes)
Activities Permitted -> Activities_Permitted__c
DME -> DME_Supplies__c
B1000 -> M1200_Vision__c
D0150 Row A Col 1 -> Little_interest_symptom_presence__c
D0150 Row A Col 2 -> Little_interest_symptom_frequency__c
D0150 Row B Col 1 -> Feeling_down_symptom_presence__c
D0150 Row B Col 2 -> Feeling_down_symptom_frequency__c
M1033 -> Functional_Points_M1033__c
M1400 -> M1400_SOB_Actual__c
M1700 -> M1700_Cognitive_Functioning__c
M1710 -> M1710_When_Confused__c
M1720 -> M1720_When_Anxious__c
M1740 -> M1740_Cognitive_behavioral_and__c
M1745 -> M1745_Frequncy_of_Disruptive_Behavior__c
M1800 -> M1800_Grooming_Actual__c
M1810 -> M1810_Ability_to_Dress_Upper_Body_Actual__c
M1820 -> M1820_Ability_to_Dress_Lower_Body_Actual__c
M1830 -> M1830_Bathing_Actual__c
M1840 -> M1840_Toilet_Transferring_Actual__c
M1845 -> M1845_Toilet_Hyg_Actual__c
M1850 -> M1850_Transferring_Actual__c
M1860 -> M1860_Ambulation_Locomotion_Actual__c
M1870 -> M1870_Feeding_Actual__c
M2020 -> M2020_Oral_Medications_Actual__c
J0530 -> J0530_Pain_Interference_with_Day_to_Da__c

GG0130 B -> GG0130_B_Oral_Hygiene__c
GG0130 C -> GG0130_C_Toileting_Hygiene__c
GG0130 E -> GG0130_E_Shower_bathe_self__c
GG0130 F -> GG0130_F_Upper_body_dressing__c
GG0130 G -> GG0130_G_Lower_body_dressing__c
GG0130 H -> GG0130_H_Putting_on_taking_off_footwear__c
GG0170 A -> GG0170_A_Roll_left_and_right__c
GG0170 B -> GG0170_B_Sit_to_lying__c
GG0170 C -> GG0170_C_Lying_to_sitting_on_side_of_bed__c
GG0170 D -> GG0170_D_Sit_to_stand__c
GG0170 E -> GG0170_E_Chair_bed_to_chair_transfer__c
GG0170 F -> GG0170_F_Toilet_transfer__c
GG0170 I -> GG0170_I_Walk_10_feet__c
GG0170 J -> GG0170_J_Walk_50_feet_with_two_turns__c
GG0170 K -> GG0170_K_Walk_150_feet__c
GG0170 L -> GG0170_L_Walking_10_feet_on_uneven_surf__c
GG0170 M -> GG0170_M_1_step_curb__c
GG0170 N -> GG0170_N_4_steps__c
GG0170 O -> GG0170_O_12_steps__c
GG0170 R -> GG0170_R_Wheel_50_feet_with_two_turns__c
GG0170 S -> GG0170_S_Wheel_150_feet__c

FINAL OUTPUT FORMAT (STRICT)
Return ONLY valid JSON.
Return a SINGLE flat JSON object.
Keys MUST be the specific keys listed above.
Values MUST be strings.
Use comma-separated values for multi-select items.
If an item is not found or not marked, return "N/A".
Do NOT include markdown, backticks, explanations, or extra text.
Do NOT include OASIS codes in the output keys.
Do NOT add or remove keys.

PICKLIST NORMALIZATION RULES (MANDATORY)
Document wording and layouts may vary. Use semantic meaning, not exact text.
Normalize selections to the VALID Salesforce picklist values below.
Return ONLY the exact picklist label.

Activities Permitted ‚Äî VALID VALUES
Complete Bed Rest, Up as Tolerated, Excercise Prescribed, Independent at Home, Cane, Walker, Best Rest BRP, Transfer Bed-Chair, Partial Weight Bearing, Crutches, Wheelchair, Other, Needs assist with ADLs, Transfer Assistance, Fall Precautions, Slow Position Changes, Wound Care, Abdom. Surgery Precautions, Requires Supervision

DME ‚Äî VALID VALUES
Bedside Commode, Cane, Elevated Toilet Seat, Grab Bars, Hospital Bed, Nebulizer, Oxygen, Tub/Shower Bench, Walker, Wheelchair, Other, Bed Overlay, Brace/Orthotics, Crutches, Hoyer Lift, Respiratory Equipment, Slider Board, Trapeze, No-DME, CPAP Machine, Diabetic Supplies, Vital Sign Equipment, Removable Shower Head, Scooter, Wound Care Supplies, Alcohol/Hand Sanitizer, Lab Supplies, PPE

OUTPUT ENFORCEMENT
Output ONLY valid picklist labels.
Multiple values must be comma-separated.
If nothing applies, return "N/A".
    `;
updateProgress(60);
    // Construct the parts array for multiple files
    const parts = [{ text: instructions }];
    fileDataArray.forEach(f => {
        parts.push({
            inlineData: { mimeType: f.mimeType, data: f.base64 }
        });
    });

    const response = await fetch(
        `${GEMINI_ENDPOINT}?key=${apiKey}`,
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: parts }]
            })
        }
    );

    if (!response.ok) {
        const errText = await response.text();
        throw new Error("Gemini API call failed: " + response.statusText);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

// 1. Save JSON to Custom Apex REST API
async function sendToSalesforce(rawJson, aiTimeSeconds) {
    const endpoint = `${SF_BASE_URL}/services/apexrest/oasis/ai-result`;

    const response = await fetch(endpoint, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + SF_SESSION_ID,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            chartId: CHART_ID,
            rawJson: rawJson,
            aiTimeSeconds: aiTimeSeconds
        })
    });

    if (!response.ok) {
        const text = await response.text();
        throw new Error("Salesforce save failed: " + text);
    }
}

// 2. Upload Files directly to ContentVersion (Standard Salesforce API)
async function saveFilesToSalesforceRecord() {
    const endpoint = `${SF_BASE_URL}/services/data/v57.0/sobjects/ContentVersion`;

    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        
        showStatus(`Uploading file ${i+1} of ${selectedFiles.length}: ${file.name}...`, false);
        
        try {
            // Re-read file to ensure fresh base64 if needed, or use cached
            const fileData = await readFileAsBase64(file); 

            const payload = {
                "Title": file.name,
                "PathOnClient": file.name,
                "VersionData": fileData.base64, 
                "FirstPublishLocationId": CHART_ID, 
                "Origin": "H" 
            };

            const response = await fetch(endpoint, {
                method: "POST",
                headers: { 
                    "Authorization": "Bearer " + SF_SESSION_ID, 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json(); 
                const errorCode = errorData[0]?.errorCode || "UNKNOWN";
                const errorMessage = errorData[0]?.message || "Unknown error";
                throw new Error(`Salesforce Error: ${errorCode} - ${errorMessage}`);
            }

            console.log(`‚úÖ Upload Success: ${file.name}`);

        } catch (err) {
            console.error(err);
            showStatus(`‚ùå Failed to upload ${file.name}: ${err.message}`, true);
        }
    }
}
        </script>
    </body>
</html>
