<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI OASIS Analyzer & ICD-10 Auditor</title>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #0b1f2a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #ffffff;
    }

    .card {
        width: 520px;
        background: #081821;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 20px 50px rgba(0,0,0,.45);
        margin: 20px 0;
        position: relative;
        border: 1px solid #1f3a4d;
    }

    h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-weight: 600;
        text-align: center;
        letter-spacing: 0.5px;
        color: #e0e0e0;
    }

    p {
        font-size: 14px;
        opacity: 0.7;
        text-align: center;
        margin-bottom: 25px;
        color: #8daac2;
    }

    /* --- FILE INPUT & LIST --- */
    .file-upload-wrapper {
        position: relative;
        margin-bottom: 15px;
    }

    /* Hide the actual input but keep it clickable via label or JS triggers if needed, 
       but here we style the input directly for simplicity */
    input[type="file"] {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px dashed #4fa3ff;
        background: #06141c;
        color: #fff;
        cursor: pointer;
        box-sizing: border-box;
        transition: border-color 0.3s;
    }
    
    input[type="file"]:hover {
        border-color: #7abaff;
        background: #091e2b;
    }

    /* The container for the list of selected files */
    #fileListContainer {
        margin-bottom: 15px;
        display: none; /* Hidden until files are added */
    }

    .file-item {
        background: #102a38;
        border: 1px solid #1f3a4d;
        border-radius: 6px;
        padding: 8px 12px;
        margin-bottom: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #d1e8ff;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .file-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 85%;
    }

    .remove-file-btn {
        background: none;
        border: none;
        color: #ff7a7a;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        padding: 0 5px;
        transition: color 0.2s;
    }

    .remove-file-btn:hover {
        color: #ff4c4c;
    }

    /* --- ACTION BUTTONS --- */
    button {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #4fa3ff, #2980b9);
        border: none;
        border-radius: 8px;
        color: #fff;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 15px rgba(79, 163, 255, 0.3);
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 163, 255, 0.4);
    }

    button:disabled {
        background: #374752;
        color: #7c8c99;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .save-btn {
        background: linear-gradient(135deg, #4cff9f, #27ae60);
        color: #052e16;
        margin-top: 15px;
        box-shadow: 0 4px 15px rgba(76, 255, 159, 0.3);
    }
    .save-btn:hover {
        background: linear-gradient(135deg, #7dfcbd, #2ecc71);
        box-shadow: 0 6px 20px rgba(76, 255, 159, 0.4);
    }

    .status {
        margin-top: 10px;
        font-size: 13px;
        min-height: 20px;
        text-align: center;
        line-height: 1.5;
        font-weight: 500;
    }

    .success { color: #4cff9f; }
    .error { color: #ff7a7a; }
    
    /* --- ADVANCED PROGRESS BAR --- */
    #progressWrapper {
        display: none;
        margin-top: 20px;
        width: 100%;
    }

    .progress-container {
        width: 100%;
        height: 8px;
        background-color: #0f2735;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4fa3ff, #00d2ff);
        border-radius: 4px;
        transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        position: relative;
        box-shadow: 0 0 10px rgba(79, 163, 255, 0.5);
    }

    .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.3) 50%,
            rgba(255, 255, 255, 0) 100%
        );
        transform: translateX(-100%);
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        100% { transform: translateX(100%); }
    }

    .progress-label {
        font-size: 12px;
        color: #4fa3ff;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }

    /* --- JSON PREVIEW --- */
    #resultArea {
        display: none;
        margin-top: 25px;
        border-top: 1px solid #1f3a4d;
        padding-top: 20px;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    textarea {
        width: 100%;
        height: 250px;
        background: #050e13;
        color: #a6e22e;
        border: 1px solid #1f3a4d;
        border-radius: 8px;
        padding: 12px;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 12px;
        resize: vertical;
        box-sizing: border-box;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
    }

    textarea:focus {
        outline: none;
        border-color: #4fa3ff;
    }

    label {
        font-size: 12px;
        color: #8daac2;
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
</head>

<body>

<div class="card">
    <h2>AI Non - OASIS Analyzer</h2>
    <p>Extraction & ICD-10 Compliance Audit</p>

    <div id="loadingMessage" style="text-align:center; color:#4fa3ff; margin-bottom:15px; font-weight:500;">
        Connecting to Salesforce...
    </div>

    <div id="mainControls" style="display:none;">
        <label>Select Documents (Multi-select allowed):</label>
        
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple onchange="handleFileSelect(this)" />
        
        <div id="fileListContainer"></div>

        <button id="analyzeBtn" onclick="startAnalysis()">
            Run Analysis & Audit
        </button>

        <div id="progressWrapper">
            <div class="progress-label">
                <span id="progressText">Initializing...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-container">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <div id="status" class="status"></div>

    <div id="resultArea">
        <label>Final Audited Result (ICD-10 Compliant):</label>
        <textarea id="jsonOutput" readonly></textarea>
        
        <button id="saveBtn" class="save-btn" onclick="finalizeSave()">
            Save to Salesforce
        </button>
    </div>
</div>

<script>
/* =========================================================
   GLOBAL CONTEXT
   ========================================================= */

let CHART_ID = null;
let GEMINI_API_KEY = null;
let SF_SESSION_ID = null;
let SF_BASE_URL = null; 
let VECTOR_STORE_ID = null;
let CACHED_AI_TIME = 0;

// Store selected files in an array
let selectedFiles = [];

const GEMINI_VISION_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent"; 
const GEMINI_RAG_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent"; 

/* =========================================================
   LISTENER: RECEIVE DATA FROM SALESFORCE LWC
   ========================================================= */

window.addEventListener("message", (event) => {
    if (event.data && event.data.type === "SF_CONTEXT") {
        console.log("‚úÖ Received Context from Salesforce");
        
        CHART_ID = event.data.recordId;
        GEMINI_API_KEY = event.data.apiKey;
        SF_SESSION_ID = event.data.sessionId;
        SF_BASE_URL = event.data.baseUrl;
        VECTOR_STORE_ID = event.data.vectorStoreId;
        
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("mainControls").style.display = "block";
        
        showStatus("‚úÖ Connected. Ready to upload files.", false);
    }
});

/* =========================================================
   FILE MANAGEMENT LOGIC
   ========================================================= */

function handleFileSelect(inputElement) {
    if (inputElement.files && inputElement.files.length > 0) {
        // Add new files to our array
        for (let i = 0; i < inputElement.files.length; i++) {
            selectedFiles.push(inputElement.files[i]);
        }
        updateFileListUI();
        
        // Clear input so same file can be selected again if needed
        inputElement.value = ""; 
        showStatus(`${selectedFiles.length} file(s) ready for analysis.`, false);
    }
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileListUI();
    if (selectedFiles.length === 0) {
        showStatus("List cleared. Please select files.", false);
    } else {
        showStatus(`${selectedFiles.length} file(s) remaining.`, false);
    }
}

function updateFileListUI() {
    const container = document.getElementById("fileListContainer");
    container.innerHTML = ""; // Clear current display

    if (selectedFiles.length === 0) {
        container.style.display = "none";
        return;
    }

    container.style.display = "block";

    selectedFiles.forEach((file, index) => {
        const item = document.createElement("div");
        item.className = "file-item";
        item.innerHTML = `
            <span class="file-name">üìÑ ${file.name}</span>
            <button class="remove-file-btn" onclick="removeFile(${index})" title="Remove">√ó</button>
        `;
        container.appendChild(item);
    });
}

/* =========================================================
   UI HELPERS (PROGRESS BAR)
   ========================================================= */

function updateProgress(percent, text) {
    const wrapper = document.getElementById("progressWrapper");
    const fill = document.getElementById("progressFill");
    const textSpan = document.getElementById("progressText");
    const percentSpan = document.getElementById("progressPercent");

    wrapper.style.display = "block";
    fill.style.width = percent + "%";
    if (text) textSpan.innerText = text;
    percentSpan.innerText = percent + "%";
}

/* =========================================================
   MAIN LOGIC (CHAINED PROMPTS)
   ========================================================= */

async function startAnalysis() {
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultArea = document.getElementById("resultArea");
    const jsonOutput = document.getElementById("jsonOutput");
    
    // Reset UI
    resultArea.style.display = "none";
    jsonOutput.value = "";
    showStatus(""); 
    
    // Checks
    if (!CHART_ID || !GEMINI_API_KEY) {
        showStatus("‚ùå Configuration missing. Refresh Salesforce page.", true);
        return;
    }

    if (selectedFiles.length === 0) {
        showStatus("‚ùå Please add at least one file.", true);
        return;
    }

    try {
        analyzeBtn.disabled = true;
        updateProgress(5, "Initializing Batch...");

        const startTime = Date.now();
        
        // --- STEP 1: READ ALL FILES ---
        updateProgress(10, `Reading ${selectedFiles.length} file(s)...`);
        
        // Convert all files to Base64 in parallel
        const filePromises = selectedFiles.map(file => readFileAsBase64(file));
        const fileDataArray = await Promise.all(filePromises);

        // --- STEP 2: VISION EXTRACTION (First Prompt) ---
        updateProgress(30, "AI Vision: Scanning all documents...");
        
        // Send ALL files to Gemini in one request
        const rawExtraction = await callGeminiVisionMulti(fileDataArray);
        console.log("Step 1 Output:", rawExtraction);

        updateProgress(60, "Extraction Done. Starting Audit...");

        // --- STEP 3: RAG AUDIT (Second Prompt) ---
        updateProgress(75, "AI Auditor: Validating ICD-10 Rules...");
        
        const finalAuditJson = await callGeminiAuditor(rawExtraction);
        
        updateProgress(95, "Finalizing results...");
        
        CACHED_AI_TIME = Math.floor((Date.now() - startTime) / 1000);

        // --- STEP 4: DISPLAY RESULT ---
        let prettyJson = finalAuditJson;
        try {
            const cleanJson = finalAuditJson.replace(/```json/g, "").replace(/```/g, "").trim();
            const parsed = JSON.parse(cleanJson);
            prettyJson = JSON.stringify(parsed, null, 4);
        } catch (e) {
            console.warn("Could not pretty print JSON");
        }

        jsonOutput.value = prettyJson;
        resultArea.style.display = "block";
        analyzeBtn.disabled = false;
        
        updateProgress(100, "Complete");
        setTimeout(() => {
             showStatus("‚úÖ Analysis & Audit Complete.", false);
        }, 800);

    } catch (error) {
        console.error(error);
        showStatus("‚ùå " + error.message, true);
        analyzeBtn.disabled = false;
        document.getElementById("progressFill").style.background = "#ff7a7a";
        document.getElementById("progressText").innerText = "Error";
    }
}

/* =========================================================
   API CALLS
   ========================================================= */

// --- CALL 1: EXTRACT DATA (MULTI-FILE SUPPORT) ---
async function callGeminiVisionMulti(fileDataArray) {
    
    const extractionPrompt = `
You are a clinical document extraction auditor.
You MUST perform a FULL scan of ALL attached documents (pages/files) before generating output.
Treat all attachments as one single patient chart.

Your job:
- Extract diagnoses EXACTLY as written
- Identify potential primary diagnoses
- Provide justification for each selected diagnosis
- Specify the exact source (Filename or Page #)

STRICT OUTPUT FORMAT (Return ONLY this text):

SECTION 1: PATIENT DIAGNOSIS DETAILS
Patient Name: <name or NOT FOUND>
Age: <age or NOT FOUND>

Potential Primary Diagnoses:
- Diagnosis: <diagnosis>
  ICD Code: <code>
  Reason & Source: <why selected, file/page>

Secondary Diagnoses:
- Diagnosis: <diagnosis>
  ICD Code: <code>
  Reason & Source: <snippet, file/page>
    `;

    // Construct the "parts" array dynamically based on number of files
    const parts = [
        { text: extractionPrompt }
    ];

    // Add each file as an inlineData part
    fileDataArray.forEach(f => {
        parts.push({
            inlineData: {
                mimeType: f.mimeType,
                data: f.base64
            }
        });
    });

    const response = await fetch(
        `${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`,
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{
                    parts: parts
                }]
            })
        }
    );

    if (!response.ok) {
        throw new Error("Step 1 (Extraction) failed: " + response.statusText);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}


// --- CALL 2: AUDIT DATA (RAG) ---
async function callGeminiAuditor(extractedText) {
    
    const auditorSystemPrompt = `
You are an Expert ICD-10-CM Medical Coding Auditor.
Your task is to perform a complete audit and produce a correct, conflict-free, clinically validated, mandatory-rule-compliant ICD-10-CM diagnostic output.

[... Standard Rules from previous context apply ...]

FINAL OUTPUT FORMAT (STRICT JSON):
[
  {
    "code": "<ICD>",
    "reasonSource": "<Explanation>",
    "potentialPrimary": true/false
  }
]
    `;

    const userPrompt = `
======================================================================
INPUT DIAGNOSES TO AUDIT:
======================================================================
${extractedText}
    `;

    let toolsConfig = [];
    if (VECTOR_STORE_ID) {
        toolsConfig = [{
            retrieval: {
                vertex_ai_search: {
                    datastore: VECTOR_STORE_ID 
                }
            }
        }];
    }

    const response = await fetch(
        `${GEMINI_RAG_ENDPOINT}?key=${GEMINI_API_KEY}`,
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                system_instruction: {
                    parts: [{ text: auditorSystemPrompt }]
                },
                contents: [{
                    parts: [{ text: userPrompt }]
                }],
                tools: toolsConfig 
            })
        }
    );

    if (!response.ok) {
        const err = await response.text();
        throw new Error("Step 2 (Audit) failed: " + err);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

/* =========================================================
   HELPER FUNCTIONS
   ========================================================= */

function showStatus(message, isError = false) {
    const status = document.getElementById("status");
    status.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
}

// Updated to return an object with mimeType and data
function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            resolve({
                mimeType: file.type,
                base64: reader.result.split(",")[1],
                name: file.name
            });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function finalizeSave() {
    const saveBtn = document.getElementById("saveBtn");
    const jsonOutput = document.getElementById("jsonOutput");
    const finalJson = jsonOutput.value;

    if (!finalJson) {
        showStatus("‚ùå No data to save", true);
        return;
    }

    try {
        saveBtn.disabled = true;
        saveBtn.innerText = "Saving...";
        showStatus("Saving results to Salesforce...");

        await sendToSalesforce(finalJson, CACHED_AI_TIME);

        showStatus("‚úÖ Saved successfully!", false);
        saveBtn.innerText = "Saved";
        
        setTimeout(() => {
             saveBtn.disabled = false;
             saveBtn.innerText = "Save to Salesforce";
        }, 3000);

    } catch (error) {
        console.error(error);
        showStatus("‚ùå Save failed: " + error.message, true);
        saveBtn.disabled = false;
        saveBtn.innerText = "Save to Salesforce";
    }
}

async function sendToSalesforce(rawJson, aiTimeSeconds) {
    const endpoint = `${SF_BASE_URL}/services/apexrest/oasis/ai-result`;

    const response = await fetch(endpoint, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + SF_SESSION_ID,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            chartId: CHART_ID,
            rawJson: rawJson,
            aiTimeSeconds: aiTimeSeconds
        })
    });

    if (!response.ok) {
        const text = await response.text();
        throw new Error("Salesforce save failed: " + text);
    }
}
</script>

</body>
</html>
